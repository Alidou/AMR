<!--///////////////////////////////////////////////////////////////////////////
//                                                                           //
//   All Mangas Reader : Follow updates of your favorite mangas sites.       //
//   Copyright (c) 2011 Pierre-Louis DUHOUX (pl.duhoux at gmail d0t com)     //
//                                                                           //
////////////////////////////////////////////////////////////////////////////-->

<html>
<head>
<title>All Mangas Reader Import / Export</title></head>

<link href="css/amr_style.css" rel="stylesheet" type="text/css">
<style>
  .button {
      max-width: 300px;
      cursor:pointer;
      margin:5px;
      display:inline-block;
      padding:4px;
  }
  .button img {
    margin-left:5px;
    vertical-align:middle;
  }
  
  .resImpDiv {
    text-align:center;
  }
  
  .resImport {
    font-weight:bold;
    margin-right:10px;
  }
</style>

<script src="js/jquery.js" type="text/javascript"></script>
<script src="js/analytics.js" type="text/javascript"></script>
<script src="js/innermenu.js" type="text/javascript"></script>

<script type="text/javascript">
  $(function() {
    loadMenu("impexp");
    $(".article").show();
    $(".ongletCont[id!='ong1']").hide();
  });
  
  //Used to request background page action
  function sendExtRequest(request, button, callback, backsrc) {
    //Prevent a second request
    if (button.data("currentlyClicked")) return;
    button.data("currentlyClicked", true);
    
    //Display a loading image
    var _ancSrc;
    if (button.is("img")) {
      _ancSrc = button.attr("src");
      button.attr("src", chrome.extension.getURL("img/load16.gif"));
    } else {
      if (button.is(".button")) {
        _ancSrc = $("<img src='" + chrome.extension.getURL("img/ltload.gif") + "'></img>")
        _ancSrc.appendTo(button);
      }
      if (button.is(".category") || button.is(".mgcategory")) {
        _ancSrc = $("<img src='" + chrome.extension.getURL("img/load10.gif") + "'></img>")
        _ancSrc.appendTo(button);
      }
    }
    //Call the action
    setTimeout(function() {
    chrome.extension.sendRequest(request, function(response) {
    //setTimeout(function() {
      //Do the callback
      callback(response);
      //Removes the loading image
      if (button.is("img")) {
        if (backsrc) {
          button.attr("src", _ancSrc);
        }
      } else {
        if (button.is(".button") || button.is(".category") || button.is(".mgcategory")) {
          _ancSrc.remove();
        }
      }
      //Restore request
      button.removeData("currentlyClicked");
    //}, 1000);
    });
    }, 10);
  }
  
  function exportData() {
    var expMgs = ($("#mgCk").attr("checked") == true);
    var expBms = ($("#bmCk").attr("checked") == true);
    /*chrome.tabs.create({url: "export.html?mg=" + expMgs + "&bm=" + expBms}, function(tab) {
    });*/
    var res = {};
    if (expMgs) {
      var mgs = chrome.extension.getBackgroundPage().getJSONListToSync();
      res.mangas = mgs;
    }
    
    if (expBms) {
      res.bookmarks = chrome.extension.getBackgroundPage().bookmarks;
    }
    
    $("#exportBox").html(JSON.stringify(res));
    $("#resExp").show();
    
  }
  
  function copy() {
    chrome.extension.getBackgroundPage().setclipboard($("#exportBox").text());
    alert("Data have been saved to clipboard.");
  }
  
  var data;
  
  function importData() {
    $("#resImp").hide();
    try {
      data = JSON.parse($("#importBox").val());
    } catch(e) {
      alert("Error while parsing data in the hereinabove box...");
      return;
    }
    //console.log(data);
    $("#resImp").empty();
    if (data.mangas) {
      $("<div class='resImpDiv'><span class='resImport'>" + JSON.parse(data.mangas).length + " mangas found.</span><div class='button' onclick='importManga(this, true);'>Import manga list (merge)</div><div class='button' onclick='importManga(this, false);'>Import manga list (erase)</div></div>").appendTo($("#resImp"));
    }
    if (data.bookmarks) {
      $("<div class='resImpDiv'><span class='resImport'>" + JSON.parse(data.bookmarks).length + " bookmarks found.</span><div class='button' onclick='importBookmark(this, true);'>Import bookmark list (merge)</div><div class='button' onclick='importBookmark(this, false);'>Import bookmark list (erase)</div></div>").appendTo($("#resImp"));
    }
    $("#resImp").show();
  }
  
  function importManga(but, mergeVal) {
    var obj = {
      action: "importMangas",
      mangas: JSON.parse(data.mangas),
      merge: mergeVal
    }
    sendExtRequest(obj, $(but), function(resp) {
      $("#resultBout").remove();
      $("<center><textarea id='resultBout' cols='90' rows='10' ></textarea></center>").appendTo($("#resImp"));
      $("#resultBout").val(resp.out);
    }, true);

  }
  
  function importBookmark(but, mergeVal) {
    var obj = {
      action: "importBookmarks",
      bookmarks: JSON.parse(data.bookmarks),
      merge: mergeVal
    }
    sendExtRequest(obj, $(but), function(resp) {
      $("#resultBout").remove();
      $("<center><textarea id='resultBout' cols='90' rows='10' ></textarea></center>").appendTo($("#resImp"));
      $("#resultBout").val(resp.out);
    }, true);
  }
  
  function switchOnglet(ong, tab) {
    $(".tab").removeClass("checked");
    $(ong).addClass("checked");
    $(".ongletCont").each(function(index) {
      if ($(this).attr("id") == tab) {
        $(this).show();
      } else {
        $(this).hide();
      }
    });
  }
  function getElementsByClass(searchClass, obj) {
  	if (!obj) {
  		obj = document;
  	}
  	
  	var classElements = new Array();
  	var els = document.getElementsByTagName('*');
  	var elsLen = els.length
  	for (i = 0, j = 0; i < elsLen; i++)
  	{
  		var classes = els[i].className.split(' ');
  		for (k = 0; k < classes.length; k++)
  			if ( classes[k] == searchClass )
  				classElements[j++] = els[i];
  	}
  	return classElements;
  }
</script>

<body onload="">
  <div id="header">
    <div id="subheader">
      <img class="imglogo" src="img/icon-32.png" width="100px" />
      <h1>All Mangas Reader Import / Export Tool</h1>
    </div>
  </div>
  <div id="menunav">
    <div id="menuitems">
      <ul>
        <li>&nbsp;</li>
      </ul>
    </div>
  </div>
  <div id="corpseone">
    <div id="subcorpseone">
      <ul class="tabs">
        <li class="tab checked" onclick="switchOnglet(this, 'ong1');">Import</li>
        <li class="tab" onclick="switchOnglet(this, 'ong2');">Export</li>
      </ul>
      <div class="article parent ongletCont" id="ong1" style="width:100%;">
      <div class="article main">
        <p>To import a file, open it (with notepad for example), copy its whole content and paste it in the bow below : </p>
        <center><textarea id="importBox" cols="90" rows="5" ></textarea></center>
        <center><div class="button" onclick="importData();">Let AMR read it !</div></center>
        <div id="resImp" style="display:none;">
          
        </div>
      </div>
      </div>
      <div class="article parent ongletCont" id="ong2" style="display:none;width:100%;">
      <div class="article main">
        <input type="checkbox" id="mgCk" checked="true"/>
        <label for="mgCk">Export manga list</label><br />
        <input type="checkbox" id="bmCk" checked="true"/>
        <label for="bmCk">Export bookmarks</label>
        <center><div class="button" onclick='exportData();'>Export file</div></center>
        
        <center>
        <div id="resExp" style="display:none;">
          <textarea id="exportBox" cols="90" rows="5"></textarea><br />
          <div class="button" onclick='copy();'>Copy content to clipboard</div>
          <p>
            To save the result of this export, click on the copy button above and paste it in a new file of your choice.
          </p>
        </div>
      </div>
      </div>
    </div>
  </div>
  <div id="footer">
    All Mangas Reader 2012.
  </div>
</body>
</html>
